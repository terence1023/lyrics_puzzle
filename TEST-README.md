# 10轮自动化测试说明

## 测试目的

这个自动化测试脚本用于验证"歌词猜猜乐"游戏的稳定性和一致性，通过连续10轮游戏测试以下内容：

1. ✅ **歌词内容一致性** - 验证目标歌词是否正确显示
2. ✅ **显示内容一致性** - 验证提交答案后的显示是否正确
3. ✅ **音频内容一致性** - 验证音频文件是否与歌曲匹配
4. ✅ **图片内容一致性** - 验证图片文件是否与歌词匹配
5. ✅ **提示字符完整性** - 验证提示字符是否包含所有答案字符
6. ✅ **游戏状态正确性** - 验证游戏结束状态是否正确

## 测试流程

每一轮测试执行以下步骤：

1. 获取当前游戏的目标歌词和相关信息
2. 直接输入正确答案
3. 点击提交按钮
4. 验证游戏状态和显示内容
5. 检查是否存在问题
6. 点击"新游戏"按钮
7. 重复上述步骤，共10轮

## 使用方法

### 方法一：使用启动脚本（推荐）

```bash
./run-test.sh
```

这个脚本会：
- 自动检查并安装依赖
- 自动启动服务器（如果未运行）
- 执行10轮测试
- 测试完成后询问是否关闭服务器

### 方法二：手动运行

1. 安装依赖：
```bash
npm install
```

2. 启动服务器（在一个终端窗口）：
```bash
npm start
```

3. 运行测试（在另一个终端窗口）：
```bash
npm run test:10rounds
```

或者直接：
```bash
node test-10-rounds.js
```

## 测试配置

可以在 `test-10-rounds.js` 文件顶部修改测试配置：

```javascript
const TEST_CONFIG = {
    rounds: 10,                          // 测试轮数
    baseUrl: 'http://localhost:3001',    // 测试服务器地址
    timeout: 10000,                      // 操作超时时间（毫秒）
    delayBetweenRounds: 2000,           // 轮次之间的延迟（毫秒）
    screenshotOnError: true              // 错误时截图
};
```

## 测试输出

### 控制台输出

测试过程中会在控制台输出：
- 每轮的测试进度
- 当前轮次的歌词、歌曲信息
- 发现的问题和错误
- 最终测试报告

### 测试报告

测试完成后会生成：

1. **JSON报告** - `test-report.json`
   - 包含所有测试结果的详细数据
   - 可用于进一步分析

2. **错误截图** - `test-screenshots/` 目录
   - 当测试失败时自动截图
   - 文件名格式：`round-{轮数}-error.png`

## 查看测试结果

测试报告示例：

```
================================
📊 测试报告
================================
总轮数: 10
成功: 10 ✅
失败: 0 ❌
成功率: 100.00%
--------------------------------
```

## 检查项目

每轮测试会检查：

- [ ] 目标歌词是否存在
- [ ] 歌曲标题是否完整
- [ ] 歌手信息是否完整
- [ ] 音频文件是否匹配
- [ ] 图片文件是否匹配
- [ ] 提示字符是否包含所有答案字符
- [ ] 游戏是否正确结束
- [ ] 游戏是否标记为胜利状态

## 常见问题

### 1. 浏览器无法启动

**问题**: puppeteer 无法启动浏览器

**解决**: 
```bash
# macOS
npm install puppeteer --unsafe-perm=true --allow-root
```

### 2. 服务器连接失败

**问题**: 测试无法连接到服务器

**解决**: 确保服务器正在运行在正确的端口（默认3001）
```bash
npm start
```

### 3. 测试超时

**问题**: 操作超时

**解决**: 增加 `TEST_CONFIG.timeout` 的值

### 4. 想看到浏览器操作过程

**方法**: 测试脚本已设置为 `headless: false`，会打开浏览器窗口显示操作过程

## 测试覆盖范围

✅ 正常游戏流程  
✅ 答案提交  
✅ 新游戏开始  
✅ 内容一致性  
✅ 状态管理  
✅ UI显示  

❌ 错误输入处理（未覆盖）  
❌ 网络异常处理（未覆盖）  
❌ 多用户并发（未覆盖）  

## 技术栈

- **Puppeteer**: 自动化浏览器控制
- **Node.js**: 运行环境
- **Express**: 游戏服务器

## 文件说明

- `test-10-rounds.js` - 主测试脚本
- `run-test.sh` - 测试启动脚本（自动化）
- `test-report.json` - 测试结果报告（自动生成）
- `test-screenshots/` - 错误截图目录（自动生成）

## 贡献

如果发现测试中的问题或想要添加更多测试用例，欢迎修改 `test-10-rounds.js` 文件。
