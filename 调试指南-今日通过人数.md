# 🔧 今日通过人数功能 - 调试指南

## 📋 问题诊断步骤

### 步骤 1: 打开调试工具
```bash
open debug-stats.html
```

这个页面会显示：
- ✅ 当前今日通过人数
- 📊 LocalStorage 中的所有相关数据
- 📝 历史统计记录
- 🔍 详细的操作日志

### 步骤 2: 测试基本功能

在调试工具页面中：

1. **查看当前数据**
   - 页面顶部显示今日通过人数
   - 下方显示今天的日期

2. **模拟通关**
   - 点击 "✅ 模拟通关（recordWin）" 按钮
   - 观察数字是否增加（首次应该增加，再次点击应该提示已记录）

3. **查看 LocalStorage**
   - 应该看到 `dailyStats` 键（JSON 格式的统计数据）
   - 应该看到 `win_2025-10-16` 键（今日的通关标记）

4. **清除记录重新测试**
   - 点击 "🗑️ 清除今日记录"
   - 再次点击 "模拟通关"，数字应该会增加

### 步骤 3: 在主页面验证

```bash
open index.html
```

1. **打开浏览器控制台**
   - 按 `Cmd + Option + I` (macOS)
   - 切换到 Console 标签页

2. **查看初始化日志**
   应该看到：
   ```
   🚀 初始化每日统计...
   📊 读取统计数据: ...
   📈 今日(2025-10-16)通过人数: 0
   🔄 更新显示 - 元素: [object HTMLDivElement] 数值: 0
   ✅ 显示已更新
   ✅ 每日统计初始化完成
   ```

3. **玩游戏通关**
   - 猜对歌词
   - 在控制台应该看到：
   ```
   🎮 尝试记录通关 - 日期: 2025-10-16, 已记录: null
   💾 保存统计数据: {2025-10-16: 1}
   ✅ 记录成功！今日通过人数: 1
   ```

4. **查看右上角数字**
   - 应该从 0 变成 1
   - 有弹跳动画效果

## 🐛 常见问题排查

### 问题 1: 页面加载时数字显示为 0，但 LocalStorage 有数据

**可能原因：**
- DOM 元素未正确初始化
- `DailyStats.init()` 未被调用

**解决方法：**
在浏览器控制台手动执行：
```javascript
DailyStats.updateDisplay();
```

如果数字正确显示，说明初始化有问题。

### 问题 2: 通关后数字不增加

**排查步骤：**

1. 检查是否已记录过
```javascript
const today = new Date();
const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
console.log('今日标记:', localStorage.getItem(`win_${todayKey}`));
```

2. 手动触发记录
```javascript
DailyStats.recordWin();
```

3. 查看控制台日志，找到错误信息

### 问题 3: 新游戏后数据丢失

**这是正常现象！**

原因：
- `newGame()` 会刷新页面
- 但 LocalStorage 数据应该保留
- 只是需要重新读取和显示

验证方法：
```javascript
// 在控制台检查数据是否还在
console.log(localStorage.getItem('dailyStats'));
```

## 🔍 手动测试脚本

### 测试 1: 检查 DailyStats 对象

在浏览器控制台运行：
```javascript
console.log('DailyStats 对象:', typeof DailyStats);
console.log('getTodayWins:', DailyStats.getTodayWins());
console.log('DOM 元素:', document.getElementById('daily-wins'));
```

### 测试 2: 模拟完整流程

```javascript
// 1. 清除今日记录
const today = new Date();
const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
localStorage.removeItem(`win_${todayKey}`);

// 2. 记录通关
DailyStats.recordWin();

// 3. 检查显示
console.log('显示的数字:', document.getElementById('daily-wins').textContent);
console.log('实际数据:', DailyStats.getTodayWins());
```

### 测试 3: 检查动画

```javascript
// 触发动画
DailyStats.showWinAnimation();
```

## 📊 数据结构说明

### LocalStorage 键值对

```javascript
// 统计数据（JSON 字符串）
"dailyStats": '{"2025-10-16":5,"2025-10-15":3}'

// 今日通关标记（字符串）
"win_2025-10-16": "true"
```

### 访问方法

```javascript
// 读取所有统计
JSON.parse(localStorage.getItem('dailyStats'))

// 读取今日标记
localStorage.getItem('win_2025-10-16')
```

## 🚑 紧急修复方法

### 如果完全不工作

1. **清空所有数据重新开始**
```javascript
localStorage.clear();
location.reload();
```

2. **手动设置初始数据**
```javascript
localStorage.setItem('dailyStats', '{"2025-10-16":0}');
DailyStats.updateDisplay();
```

3. **检查浏览器支持**
```javascript
if (typeof(Storage) !== "undefined") {
    console.log("✅ 浏览器支持 LocalStorage");
} else {
    console.log("❌ 浏览器不支持 LocalStorage");
}
```

## 📝 调试日志说明

| Emoji | 含义 | 日志级别 |
|-------|------|---------|
| 🚀 | 初始化开始 | INFO |
| ✅ | 操作成功 | SUCCESS |
| 📊 | 读取数据 | INFO |
| 💾 | 保存数据 | INFO |
| 📈 | 统计信息 | INFO |
| 🔄 | 更新显示 | INFO |
| 🎮 | 游戏事件 | INFO |
| ❌ | 错误 | ERROR |
| ℹ️ | 提示信息 | WARN |

## 🎯 预期行为

### 首次访问页面
1. 右上角显示 "0"
2. LocalStorage 为空或有历史数据

### 首次通关
1. 数字从 0 变成 1
2. 播放弹跳动画
3. LocalStorage 保存数据

### 再次通关（同一天）
1. 数字保持不变
2. 控制台显示 "今日已记录过"

### 第二天访问
1. 数字重置为 0（新的一天）
2. 但历史数据保留

## 📞 需要帮助？

如果以上步骤都无法解决问题，请提供：

1. **浏览器控制台的完整日志**
2. **LocalStorage 的内容**（在 Application 标签页查看）
3. **具体的操作步骤**
4. **出现的错误信息**

---

**更新日期**: 2025-10-16
**版本**: v1.1.0 (添加调试日志)
