<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计功能调试</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #667eea;
            margin-top: 0;
        }
        button {
            background: #6aaa64;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a9a54;
        }
        button.danger {
            background: #d32f2f;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .stats-display {
            font-size: 32px;
            font-weight: bold;
            color: #6aaa64;
            text-align: center;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>📊 今日通过人数统计 - 调试工具</h1>
    
    <div class="debug-panel">
        <h2>当前状态</h2>
        <div class="stats-display" id="current-wins">加载中...</div>
        <p style="text-align: center;">今日日期: <strong id="today-date"></strong></p>
    </div>
    
    <div class="debug-panel">
        <h2>测试操作</h2>
        <button onclick="testRecordWin()">✅ 模拟通关（recordWin）</button>
        <button onclick="testUpdateDisplay()">🔄 刷新显示（updateDisplay）</button>
        <button onclick="clearTodayRecord()">🗑️ 清除今日记录</button>
        <button onclick="clearAll()" class="danger">⚠️ 清空所有数据</button>
    </div>
    
    <div class="debug-panel">
        <h2>LocalStorage 数据</h2>
        <table id="storage-table">
            <thead>
                <tr>
                    <th>键</th>
                    <th>值</th>
                </tr>
            </thead>
            <tbody id="storage-data">
            </tbody>
        </table>
        <button onclick="refreshStorageDisplay()">🔄 刷新数据</button>
    </div>
    
    <div class="debug-panel">
        <h2>历史统计</h2>
        <div id="history-stats"></div>
    </div>
    
    <div class="debug-panel">
        <h2>控制台日志</h2>
        <div id="console-log" class="log"></div>
        <button onclick="clearLog()">清空日志</button>
    </div>
    
    <script>
        // 日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#0f0',
                error: '#f00',
                warn: '#ff0',
                success: '#0ff'
            };
            const entry = document.createElement('div');
            entry.style.color = colors[type] || '#0f0';
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('console-log').innerHTML = '';
        }
        
        // 获取今日日期
        function getTodayKey() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }
        
        // 获取统计数据
        function getStats() {
            try {
                const stats = localStorage.getItem('dailyStats');
                return stats ? JSON.parse(stats) : {};
            } catch (e) {
                log('❌ 读取统计数据失败: ' + e.message, 'error');
                return {};
            }
        }
        
        // 保存统计数据
        function saveStats(stats) {
            try {
                localStorage.setItem('dailyStats', JSON.stringify(stats));
                log('💾 统计数据已保存', 'success');
            } catch (e) {
                log('❌ 保存统计数据失败: ' + e.message, 'error');
            }
        }
        
        // 获取今日通过人数
        function getTodayWins() {
            const stats = getStats();
            const today = getTodayKey();
            return stats[today] || 0;
        }
        
        // 更新显示
        function updateDisplay() {
            const wins = getTodayWins();
            const today = getTodayKey();
            document.getElementById('current-wins').textContent = wins;
            document.getElementById('today-date').textContent = today;
            log(`📈 当前显示: ${wins} 人通过`, 'info');
        }
        
        // 测试 recordWin
        function testRecordWin() {
            const stats = getStats();
            const today = getTodayKey();
            const winRecordKey = `win_${today}`;
            const hasRecorded = localStorage.getItem(winRecordKey);
            
            log(`🎮 测试 recordWin - 日期: ${today}`, 'info');
            log(`   已记录标记: ${hasRecorded}`, 'info');
            
            if (!hasRecorded) {
                stats[today] = (stats[today] || 0) + 1;
                saveStats(stats);
                localStorage.setItem(winRecordKey, 'true');
                log(`✅ 记录成功！今日通过人数: ${stats[today]}`, 'success');
                updateDisplay();
                refreshStorageDisplay();
                showHistory();
            } else {
                log('ℹ️ 今日已记录过通关，跳过', 'warn');
            }
        }
        
        // 测试 updateDisplay
        function testUpdateDisplay() {
            log('🔄 测试 updateDisplay', 'info');
            updateDisplay();
        }
        
        // 清除今日记录
        function clearTodayRecord() {
            const today = getTodayKey();
            const winRecordKey = `win_${today}`;
            localStorage.removeItem(winRecordKey);
            log(`🗑️ 已清除今日记录标记: ${winRecordKey}`, 'warn');
            refreshStorageDisplay();
        }
        
        // 清空所有数据
        function clearAll() {
            if (confirm('确定要清空所有统计数据吗？')) {
                localStorage.removeItem('dailyStats');
                for (let key in localStorage) {
                    if (key.startsWith('win_')) {
                        localStorage.removeItem(key);
                    }
                }
                log('🗑️ 所有数据已清空', 'warn');
                updateDisplay();
                refreshStorageDisplay();
                showHistory();
            }
        }
        
        // 刷新 LocalStorage 显示
        function refreshStorageDisplay() {
            const tbody = document.getElementById('storage-data');
            tbody.innerHTML = '';
            
            const relevantKeys = [];
            for (let key in localStorage) {
                if (key === 'dailyStats' || key.startsWith('win_')) {
                    relevantKeys.push(key);
                }
            }
            
            if (relevantKeys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#999;">暂无数据</td></tr>';
            } else {
                relevantKeys.sort().forEach(key => {
                    const tr = document.createElement('tr');
                    const tdKey = document.createElement('td');
                    const tdValue = document.createElement('td');
                    tdKey.textContent = key;
                    tdValue.textContent = localStorage.getItem(key);
                    tdValue.style.fontFamily = 'monospace';
                    tdValue.style.fontSize = '12px';
                    tr.appendChild(tdKey);
                    tr.appendChild(tdValue);
                    tbody.appendChild(tr);
                });
            }
            log('🔄 LocalStorage 数据已刷新', 'info');
        }
        
        // 显示历史统计
        function showHistory() {
            const stats = getStats();
            const historyDiv = document.getElementById('history-stats');
            
            if (Object.keys(stats).length === 0) {
                historyDiv.innerHTML = '<p style="color:#999;">暂无历史数据</p>';
            } else {
                let html = '<table style="width:100%;"><tr><th>日期</th><th>通过人数</th></tr>';
                const sortedDates = Object.keys(stats).sort().reverse();
                sortedDates.forEach(date => {
                    html += `<tr><td>${date}</td><td><strong>${stats[date]}</strong> 人</td></tr>`;
                });
                html += '</table>';
                historyDiv.innerHTML = html;
            }
        }
        
        // 初始化
        window.onload = function() {
            log('✅ 调试工具加载完成', 'success');
            updateDisplay();
            refreshStorageDisplay();
            showHistory();
        };
    </script>
</body>
</html>
